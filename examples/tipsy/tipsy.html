<html>
  <head>
    <script type="text/javascript" src="../../lib/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="../../lib/tipsy/jquery.tipsy.js"></script>
    <script type="text/javascript" src="../../polymaps.js"></script>
    <style type="text/css">

@import url("../../lib/tipsy/tipsy.css");
@import url("../example.css");

body {
  font: 12px Helvetica Neue;
  overflow: hidden;
}

.layer circle {
  fill: lightcoral;
  fill-opacity: .5;
  stroke: brown;
  stroke-width: 1.5px;
}

.tipsy-inner {
  padding: 3px;
}

.tipsy-inner img {
  -moz-border-radius: 3px;
  -webkit-border-radius: 3px;
  background: white;
}

    </style>
  </head>
  <body>
    <script type="text/javascript">

var po = org.polymaps;

var tips = {};

var map = po.map()
    .container(document.body.appendChild(po.svg("svg")))
    .center({lon: -122.20877392578124, lat: 37.65175620758778})
    .zoom(10)
    .add(po.interact())
    .on("move", move)
    .on("resize", move);

map.add(po.image()
    .url(po.url("http://{S}tile.cloudmade.com"
    + "/1a1b06b230af4efdbb989ea99e9841af" // http://cloudmade.com/register
    + "/998/256/{Z}/{X}/{Y}.png")
    .hosts(["a.", "b.", "c.", ""])));

map.add(po.geoJson()
    .on("load", load)
    .on("show", show)
    .features([
{
  "id": "stanford",
  "properties": {
    "html": "<img src='stanford.png' width=200 height=200>"
  },
  "geometry": {
    "coordinates": [-122.16894848632812, 37.42961865341856],
    "type": "Point"
  }
},
{
  "id": "berkeley",
  "properties": {
    "html": "<img src='berkeley.png' width=200 height=200>"
  },
  "geometry": {
    "coordinates": [-122.26358225200948, 37.872092652605886],
    "type": "Point"
  }
}
    ]));

map.add(po.compass()
    .pan("none"));

function load(e) {
  for (var i = 0; i < e.features.length; i++) {
    var f = e.features[i];
    f.element.setAttribute("r", 10);
    f.element.addEventListener("mousedown", toggle(f.data), false);
    f.element.addEventListener("dblclick", cancel, false);
  }
}

function show(e) {
  for (var i = 0; i < e.features.length; i++) {
    var f = e.features[i], tip = tips[f.data.id];
    tip.feature = f.data;
    tip.target = f.element;
    update(tip);
  }
}

function move() {
  for (var id in tips) {
    update(tips[id]);
  }
}

function cancel(e) {
  e.stopPropagation();
  e.preventDefault();
}

function update(tip) {
  if (!tip.visible) return; // ignore
  if (!tip.target.ownerSVGElement) {
    tip.visible = false;
    $(tip.anchor).tipsy("hide");
    return;
  }
  var box = po.svg.bbox(tip.target);
  tip.anchor.style.left = box.x + "px";
  tip.anchor.style.top = box.y + "px";
  tip.anchor.style.width = box.width + "px";
  tip.anchor.style.height = box.height + "px";
  $(tip.anchor).tipsy("show");
}

function toggle(f) {
  var tip = tips[f.id];
  if (!tip) {
    tip = tips[f.id] = {
      anchor: document.body.appendChild(document.createElement("a")),
      visible: false,
      toggle: function(e) {
        tip.visible = !tip.visible;
        update(tip);
        $(tip.anchor).tipsy(tip.visible ? "show" : "hide");
        cancel(e);
      }
    };
    tip.anchor.style.position = "absolute";
    tip.anchor.style.visibility = "hidden";
    $(tip.anchor).tipsy({
      html: true,
      fallback: f.properties.html,
      gravity: $.fn.tipsy.autoNS,
      trigger: "manual"
    });
  }
  return tip.toggle;
}

po.svg.bbox = function(e) {
  var box = e.getBBox(),
      tl = e.ownerSVGElement.createSVGPoint(),
      br = e.ownerSVGElement.createSVGPoint(),
      ctm = e.getScreenCTM(),
      x,
      y;
  tl.x = box.x;
  tl.y = box.y;
  br.x = box.x + box.width;
  br.y = box.y + box.width;
  tl = tl.matrixTransform(ctm);
  br = br.matrixTransform(ctm);
  return {
    x: x = Math.floor(Math.min(tl.x, br.x)),
    y: y = Math.floor(Math.min(tl.y, br.y)),
    width: Math.ceil(Math.max(tl.x, br.x)) - x,
    height: Math.ceil(Math.max(tl.y, br.y)) - y
  };
};

    </script>
    <span id="copy">
      &copy; 2010
      <a href="http://www.cloudmade.com/">CloudMade</a>,
      <a href="http://www.openstreetmap.org/">OpenStreetMap</a> contributors,
      <a href="http://creativecommons.org/licenses/by-sa/2.0/">CCBYSA</a>.
    </span>
  </body>
</html>
